{% extends "base.html" %}
{% block head %}
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="/sid-static/leaflet/leaflet.js"></script>
    <script src="/sid-static/map/js/tilelayer.js"></script>
    <script src="/sid-static/map/js/OSMBuildings-Leaflet.js"></script>
    <script src="/sid-static/map/js/providers.js"></script>
    <script src="/sid-static/map/js/Control.FullScreen.js"></script>


    <link rel="stylesheet" href="/sid-static/leaflet/leaflet.css"/>
    <link rel="stylesheet" href="/sid-static/map/css/Control.FullScreen.css"/>

{% endblock %}
{% block filter_box %}
    <div id="filter-box">
        <div>
            <form id="map-search" method="get">
                <label for="search">Search</label>
                <input type="text" id="search" name="search"/>
                <input type="submit" value="Search" id="submit-map-search"/>
            </form>
        </div>
        <div id="search-results">
            <div id="errors"></div>
            <div id="buildings"></div>
            <div id="rooms"></div>
        </div>
        <div id="filter-layers">
            <label id="buildings" for="buildings">Buildings</label>
            <select id="buildings_select">
                <option value="soda_hall" selected>Soda Hall</option>
                <option value="cory_hall">Cory Hall</option>
                <option value="etcheverry">Etcheverry</option>
            </select>
            <label for="floors">Floors</label>
            <select id="floors_select" name="floors">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3" selected>3</option>
            </select>
        </div>

    </div>

{% endblock %}
{% block before_body_close %}
    <div id="map" style="width: 600px; height: 400px"></div>

    <script>
        var floor = $("#floors_select").find(":selected").val();
        var building = $("#buildings_select").find(":selected").val();

        var users;
        var map = L.map('map').setView([37.87566, -122.258641], 18);


        L.tileLayer.provider('Stamen.TonerLite').addTo(map);
        var style = {
            "clickable": true,
            "color": "#102CE3",
            "fillColor": "#102CE3",
            "weight": 1.0,
            "opacity": 0.5,
            "fillOpacity": 0.5,
            "maxZoom": 18

        };
        L.control.fullscreen({
            position: 'topleft',
            title: 'Show me the fullscreen !'
        }).addTo(map);

        var hoverStyle = {
            "fillOpacity": 0.5,
             "fillColor": "#EE1EE1"
        };
        var userStyle = {
            "fillOpacity": 0.7,
            "fillColor": '#E3C710'
        };


        var geojsonURL = "http://127.0.0.1:8000/" + building + "/" + floor + "/data.geojson";


        $("#filter-layers").change(function () {
            location.reload(false);
        });
        var geojsonTileLayer = new L.TileLayer.GeoJSON(geojsonURL, {
                    clipTiles: true,
                    unique: function (feature) {
                        return feature.id;
                    }
                }, {
                    style: style,

                    onEachFeature: function (feature, layer) {
                        if (feature.properties) {
                            var room = feature.properties['room'];
                            var popupString = '<div id=' + room + ' class="popup">';
                            popupString += 'Room: ' + room + '<br /> Users: <br/>';
                            layer.users = false;
                            for (var i = 0; i < users.length; i++) {
                                var user = users[i];
                                if (user.room === room) {
                                    layer.users = true;
                                    popupString += user.username + "<br/>";
                                    layer.setStyle(userStyle);

                                }
                            }


                            popupString += '</div>';
                            layer.bindPopup(popupString);
                        }

                        if (!(layer instanceof L.Point) && !layer.users) {
                            layer.on('mouseover', function () {
                                layer.setStyle(hoverStyle);
                            });
                            layer.on('mouseout', function () {
                                layer.setStyle(style);
                            });
                        }

                    }
                }
        );
        var online_users = $.getJSON(
                "http://127.0.0.1:8000/users/online-users/" + building + "/" + floor + "?format=json",
                function (json) {
                    users = json.results;
                    map.addLayer(geojsonTileLayer);
                }
        );


    </script>
{% endblock %}